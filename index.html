<html>
<head>
    <link href="style.css" rel="stylesheet">
    <link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet">
</head>
<body>
<div class="content">
    <!-- Introduction -->
    <div class="row">
        <div class="col-md-9">
            <div id="map" style="height:65vh; width:100%;"></div>
            <div class="mt-3" id="graph" style="background-color: #343434; height: 27.5vh; width: 100%;"></div>
        </div>
        <div class="col-md-3">
            <table class="table table-striped" id="stands">
                <thead>
                <tr>
                    <th><i class="fa fa-bicycle"></i> Loading Bike Stands..</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Plugins -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<script src="https://d3js.org/d3.v5.min.js" crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
      integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
      crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
        integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
        crossorigin="anonymous"></script>

<script src="vendor/es-csv/es-csv.js"></script>
<script src="vendor/gunzip/gunzip.min.js"></script>

<link rel="stylesheet" type="text/css"
      href="https://cdn.datatables.net/v/bs4/dt-1.10.20/r-2.2.3/sc-2.0.1/sp-1.0.1/sl-1.3.1/datatables.min.css"/>
<script type="text/javascript"
        src="https://cdn.datatables.net/v/bs4/dt-1.10.20/r-2.2.3/sc-2.0.1/sp-1.0.1/sl-1.3.1/datatables.min.js"></script>

<script src="xmlhttprequest.js"></script>

<script>
    // Source: https://digitransit.fi/en/developers/apis/3-map-api/background-map/
    var map = L.map('map').setView([60.192059, 24.945831], 13);

    // Show the HSL map background
    L.tileLayer('https://cdn.digitransit.fi/map/v1/{id}/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
        maxZoom: 17,
        minZoom: 9,
        tileSize: 512,
        zoomOffset: -1,
        id: 'hsl-map'
    }).addTo(map);

    request("data/gz/tellingit_2017-2019.csv.gz", function (data, error) {
        const plain = new Zlib.Gunzip(data).decompress();
        const asString = new TextDecoder("utf-8").decode(plain);
        const parsed = CSV.parse(asString);

        const objModel = parsed[0];

        const asObjects = [];
        for (let i = 1; i < parsed.length; i++) {
            const entry = parsed[i];
            const object = {};
            let j = 0;
            for (var key of objModel) {
                object[key] = entry[j].trim();
                j++;
            }
            asObjects.push(object);
        }

        console.log("Object model: ", objModel, " - Loaded: ", asObjects.length + " rows");

        const bikeStands = {};
        for (let object of asObjects) {
            // if (object.id.length !== 3) continue; // Ignore test entries
            bikeStands[object.id] = {
                id: object.id,
                name: object.name,
                x: parseFloat(object.x.replace(',', '.')),
                y: parseFloat(object.y.replace(',', '.')),
                time: new Date(object.time)
            };
        }

        for (let invalid of ['0', '1', '0390', '0533', '0534', '0529', '0523']) {
            delete bikeStands[invalid];
        }

        const visibleCircleOptions = {
            color: '#0099cc',
            fillColor: '#0099cc',
            fillOpacity: 0.5,
            opacity: 1.0,
            radius: 40,
            weight: 1
        };
        const selectedCircleOptions = {
            ...visibleCircleOptions,
            color: '#ffac63',
            fillColor: '#ffac63',
        };
        const hiddenCircleOptions = {
            ...visibleCircleOptions,
            color: '#929292',
            fillColor: '#929292',
            opacity: 0.7,
            radius: 20
        };

        // Draw bike stands on the map
        for (let key of Object.keys(bikeStands)) {
            const stand = bikeStands[key];
            stand.marker = L.circle([stand.y, stand.x], visibleCircleOptions)
                .bindPopup(stand.id + " : " + stand.name, {autoClose: false}).addTo(map);
        }

        console.log("Parsed stands: ", bikeStands);

        let filteredIDs = [];
        let selectedIDs = [];

        let previousFilterLength = 0;
        let previousSelectLength = -1;

        function updateView() {
            const pointLatLngs = [];
            for (let key of Object.keys(bikeStands)) {
                const stand = bikeStands[key];
                const hasNoFilter = !filteredIDs || !filteredIDs.length;
                const isVisible = hasNoFilter || filteredIDs.includes(stand.id);

                const hasNoSelection = !selectedIDs || !selectedIDs.length;
                const isSelected = hasNoSelection || selectedIDs.includes(stand.id);

                if (isSelected) {
                    pointLatLngs.push(stand.marker.getLatLng());
                }
                if (!hasNoSelection && isSelected) {
                    stand.marker.setStyle(selectedCircleOptions)
                        .setRadius(stand.marker.options.radius)
                        .openPopup();
                } else {
                    stand.marker.closePopup();
                    if (isVisible) {
                        stand.marker.setStyle(visibleCircleOptions)
                            .setRadius(stand.marker.options.radius - (hasNoFilter ? 20 : 0));
                    } else {
                        stand.marker.setStyle(hiddenCircleOptions)
                            .setRadius(stand.marker.options.radius);
                    }
                }
            }
            if (previousSelectLength !== selectedIDs.length) {
                var bounds = new L.LatLngBounds(pointLatLngs);
                map.flyToBounds(bounds, {animate: true, easeLinearity: 0.1, duration: 1.5});
            }

            previousFilterLength = filteredIDs.length;
            previousSelectLength = selectedIDs.length;
        }

        updateView();

        const table = $('#stands').DataTable({
            responsive: true,
            select: true,
            scrollY: "80vh",
            scrollCollapse: true,
            paging: false,
            columns: [{title: '<i class="fa fa-bicycle"></i> Bike Stands', data: 'name'}],
            data: Object.keys(bikeStands).map(function (key) {
                return {...bikeStands[key]}
            }),
            order: [[0, "asc"]]
        });
        table.on('search.dt', function () {
            if (!table.search()) {
                filteredIDs = [];
            } else {
                filteredIDs = table.rows({search: 'applied'})
                    .data().pluck('id').toArray();
            }
            updateView();
        });
        table.on('select', function (e, dt, type, indexes) {
            if (type === 'row') {
                table.rows(indexes).data().pluck('id')
                    .toArray().forEach(function (id) {
                    selectedIDs.push(id);
                });
                updateView();
            }
        });
        table.on('deselect', function (e, dt, type, indexes) {
            if (type === 'row') {
                var toRemove = table.rows(indexes).data().pluck('id')
                    .toArray();
                selectedIDs = selectedIDs.filter(function (id) {
                    return !toRemove.includes(id);
                });
                updateView();
            }
        });
    });
</script>
</body>
</html>